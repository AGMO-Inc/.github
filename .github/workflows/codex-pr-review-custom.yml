name: Codex PR Review - Custom (Reusable)

on:
  workflow_call:
    inputs:
      model:
        description: "Model name for review (e.g. your Codex model id)"
        required: false
        type: string
        default: "gpt-4.1-mini"
      max_diff_bytes:
        description: "Limit diff size to avoid huge payloads"
        required: false
        type: number
        default: 180000
    secrets:
      CODEX_API_TOKEN:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          owner="${{ github.repository_owner }}"
          repo="$(echo "${{ github.repository }}" | cut -d/ -f2)"
          pr="${{ github.event.pull_request.number }}"

          curl -sS -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/${owner}/${repo}/pulls/${pr}" \
            > pr.diff

          max="${{ inputs.max_diff_bytes }}"
          size=$(wc -c < pr.diff | tr -d ' ')
          if [ "$size" -gt "$max" ]; then
            head -c "$max" pr.diff > pr.diff.trunc
            mv pr.diff.trunc pr.diff
            echo "truncated=true" >> "$GITHUB_OUTPUT"
          else
            echo "truncated=false" >> "$GITHUB_OUTPUT"
          fi

          echo "diff_path=pr.diff" >> "$GITHUB_OUTPUT"

      - name: Build request payload
        id: payload
        env:
          MODEL: ${{ inputs.model }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          set -euo pipefail

          cat > payload.json <<'JSON'
          {
            "model": "__MODEL__",
            "input": [
              {
                "role": "system",
                "content": [
                  {
                    "type": "text",
                    "text": "You are a senior engineer reviewing a GitHub pull request diff. Score the PR using 5 categories, 0-20 each, total 0-100. Use this rubric (custom/general): (1) Requirements & Correctness, (2) Code Quality & Maintainability, (3) Security & Privacy, (4) Performance & Reliability, (5) Tests & Operability. Output MUST be valid JSON per the provided schema. Keep feedback actionable and concise."
                  }
                ]
              },
              {
                "role": "user",
                "content": [
                  {
                    "type": "text",
                    "text": "PR title: __TITLE__\nPR author: __AUTHOR__\n\nDIFF:\n__DIFF__"
                  }
                ]
              }
            ],
            "text": {
              "format": {
                "type": "json_schema",
                "name": "pr_review",
                "schema": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "total_score": { "type": "integer", "minimum": 0, "maximum": 100 },
                    "scores": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "requirements_correctness": { "type": "integer", "minimum": 0, "maximum": 20 },
                        "code_quality": { "type": "integer", "minimum": 0, "maximum": 20 },
                        "security_privacy": { "type": "integer", "minimum": 0, "maximum": 20 },
                        "performance_reliability": { "type": "integer", "minimum": 0, "maximum": 20 },
                        "tests_operability": { "type": "integer", "minimum": 0, "maximum": 20 }
                      },
                      "required": [
                        "requirements_correctness",
                        "code_quality",
                        "security_privacy",
                        "performance_reliability",
                        "tests_operability"
                      ]
                    },
                    "summary": { "type": "string" },
                    "strengths": { "type": "array", "items": { "type": "string" } },
                    "major_issues": { "type": "array", "items": { "type": "string" } },
                    "recommendations": { "type": "array", "items": { "type": "string" } }
                  },
                  "required": ["total_score", "scores", "summary", "strengths", "major_issues", "recommendations"]
                }
              }
            }
          }
          JSON

          python - <<'PY'
          import json, os
          p = json.load(open("payload.json", "r", encoding="utf-8"))
          p["model"] = os.environ["MODEL"]
          text = p["input"][1]["content"][0]["text"]
          text = text.replace("__TITLE__", os.environ.get("PR_TITLE", ""))
          text = text.replace("__AUTHOR__", os.environ.get("PR_AUTHOR", ""))
          p["input"][1]["content"][0]["text"] = text
          json.dump(p, open("payload.json", "w", encoding="utf-8"), ensure_ascii=False)
          PY

      - name: Call API and format comment
        id: call
        env:
          OPENAI_API_KEY: ${{ secrets.CODEX_API_TOKEN }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          p = json.load(open("payload.json", "r", encoding="utf-8"))
          diff = open("pr.diff", "r", encoding="utf-8", errors="replace").read()
          p["input"][1]["content"][0]["text"] = p["input"][1]["content"][0]["text"].replace("__DIFF__", diff)
          json.dump(p, open("payload.json", "w", encoding="utf-8"), ensure_ascii=False)
          PY

          resp="$(curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload.json)"

          printf '%s' "$resp" > resp.json

          python - <<'PY' > review.json
          import json
          r = json.load(open("resp.json", "r", encoding="utf-8", errors="replace"))
          out = r.get("output_text")
          if not out:
            out_items = []
            for item in r.get("output", []):
              for c in item.get("content", []):
                if c.get("type") in ("output_text", "text"):
                  out_items.append(c.get("text", ""))
            out = "\n".join(out_items).strip()
          print(out)
          PY

          python - <<'PY'
          import json
          raw = open("review.json", "r", encoding="utf-8", errors="replace").read().strip()
          try:
            data = json.loads(raw)
          except Exception:
            data = {
              "total_score": 0,
              "scores": {
                "requirements_correctness": 0,
                "code_quality": 0,
                "security_privacy": 0,
                "performance_reliability": 0,
                "tests_operability": 0
              },
              "summary": raw,
              "strengths": [],
              "major_issues": [],
              "recommendations": []
            }

          def section(title, items):
            if not items:
              return ""
            s = f"### {title}\n"
            for x in items:
              s += f"- {x}\n"
            return s + "\n"

          scores = data.get("scores", {})
          total = data.get("total_score")
          if total is None:
            total = sum(int(scores.get(k, 0) or 0) for k in scores.keys())

          md = "## Codex Review\n\n"
          md += f"**Score:** {total}/100\n\n"
          md += "| Category | Score |\n|---|---:|\n"
          md += f"| Requirements & Correctness | {scores.get('requirements_correctness', 0)}/20 |\n"
          md += f"| Code Quality & Maintainability | {scores.get('code_quality', 0)}/20 |\n"
          md += f"| Security & Privacy | {scores.get('security_privacy', 0)}/20 |\n"
          md += f"| Performance & Reliability | {scores.get('performance_reliability', 0)}/20 |\n"
          md += f"| Tests & Operability | {scores.get('tests_operability', 0)}/20 |\n\n"
          md += f"**Summary:** {data.get('summary','')}\n\n"
          md += section("Strengths", data.get("strengths", []))
          md += section("Major Issues", data.get("major_issues", []))
          md += section("Recommendations", data.get("recommendations", []))
          open("comment.md", "w", encoding="utf-8").write(md)
          PY

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          owner="${{ github.repository_owner }}"
          repo="$(echo "${{ github.repository }}" | cut -d/ -f2)"
          pr="${{ github.event.pull_request.number }}"

          python - <<'PY' > body.json
          import json
          body = open("comment.md", "r", encoding="utf-8", errors="replace").read()
          print(json.dumps({"body": body}))
          PY

          curl -sS -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d @body.json \
            "https://api.github.com/repos/${owner}/${repo}/issues/${pr}/comments" \
            > /dev/null
