name: Codex PR Review - Frontend (Reusable)

on:
  workflow_call:
    inputs:
      model:
        description: "Model name for review (leave empty to use gpt-5.2-codex)"
        required: false
        type: string
        default: "gpt-5.2-codex"
      max_diff_bytes:
        description: "Limit diff size to avoid huge payloads"
        required: false
        type: number
        default: 180000
    secrets:
      CODEX_API_TOKEN:
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Check out PR merge commit
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Fetch PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          owner="${{ github.repository_owner }}"
          repo="$(echo "${{ github.repository }}" | cut -d/ -f2)"
          pr="${{ github.event.pull_request.number }}"

          curl -sS -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/${owner}/${repo}/pulls/${pr}" \
            > pr.diff

          max="${{ inputs.max_diff_bytes }}"
          size=$(wc -c < pr.diff | tr -d ' ')
          if [ "$size" -gt "$max" ]; then
            head -c "$max" pr.diff > pr.diff.trunc
            mv pr.diff.trunc pr.diff
            echo "truncated=true" >> "$GITHUB_OUTPUT"
          else
            echo "truncated=false" >> "$GITHUB_OUTPUT"
          fi

          echo "diff_path=pr.diff" >> "$GITHUB_OUTPUT"

      - name: Build Codex prompt and schema
        id: prompt
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_FULL: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body || '' }}
          DIFF_TRUNCATED: ${{ steps.diff.outputs.truncated }}
        run: |
          set -euo pipefail

          cat > codex_prompt.md <<'EOF'
          ë‹¹ì‹ ì€ í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë¦¬ë·°ì–´ë‹¤.

          ## í”„ë¡ íŠ¸ì—”ë“œ ë¦¬ë·° ê¸°ì¤€ (5 x 20 = 100)

          ### 1. ë³´ì•ˆ (0-20)
          - XSS ìœ„í—˜(dangerouslySetInnerHTML, ê²€ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ì…ë ¥)ì´ ì—†ì–´ì•¼ í•œë‹¤.
          - í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì— ë¹„ë°€ê°’, API í‚¤, í† í° í•˜ë“œì½”ë”©ì´ ì—†ì–´ì•¼ í•œë‹¤.
          - ë Œë”ë§ ì „ ì…ë ¥ê°’ ì •ì œ/ê²€ì¦ì´ ì ì ˆíˆ ì ìš©ë˜ì–´ì•¼ í•œë‹¤.
          - localStorage/sessionStorageì— ë¯¼ê°ì •ë³´ ì €ì¥ì´ ì‹ ì¤‘íˆ ê´€ë¦¬ë˜ì–´ì•¼ í•œë‹¤.
          - ìƒíƒœ ë³€ê²½ ìš”ì²­ì—ì„œ CSRF ë“± ê¸°ë³¸ ë³´ì•ˆ ê³ ë ¤ê°€ ë°˜ì˜ë˜ì–´ì•¼ í•œë‹¤.

          ### 2. ì½”ë“œ í’ˆì§ˆ (0-20)
          - TypeScript/React ì½”ë“œê°€ ì½ê¸° ì‰½ê³  í”„ë¡œì íŠ¸ ê·œì¹™ì„ ë”°ë¼ì•¼ í•œë‹¤.
          - íƒ€ì… ì•ˆì •ì„±ì´ ì ì ˆí•´ì•¼ í•˜ë©° ë¶ˆí•„ìš”í•œ any ë‚¨ìš©ì´ ì—†ì–´ì•¼ í•œë‹¤.
          - ì»´í¬ë„ŒíŠ¸/í›… ì±…ì„ì´ ê³¼ë„í•˜ê²Œ ì„ì´ì§€ ì•Šì•„ì•¼ í•œë‹¤.
          - useEffect ì˜ì¡´ì„±/ì •ë¦¬(cleanup)ê°€ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•œë‹¤.
          - ë¶ˆí•„ìš”í•œ ë³µì¡ë„, ì¤‘ë³µ, ì£½ì€ ì½”ë“œê°€ ì—†ì–´ì•¼ í•œë‹¤.

          ### 3. UI/UX ë° ì ‘ê·¼ì„± (0-20)
          - ë””ìì¸ ì‹œìŠ¤í…œ/í† í°/ì»´í¬ë„ŒíŠ¸ íŒ¨í„´ì„ ì¤€ìˆ˜í•´ì•¼ í•œë‹¤.
          - ë°˜ì‘í˜•ê³¼ ëª¨ë°”ì¼ í™˜ê²½ ë™ì‘ì´ ìì—°ìŠ¤ëŸ¬ì›Œì•¼ í•œë‹¤.
          - ì‹œë§¨í‹± ë§ˆí¬ì—…, aria, í‚¤ë³´ë“œ íƒìƒ‰ ë“± ì ‘ê·¼ì„±ì´ í™•ë³´ë˜ì–´ì•¼ í•œë‹¤.
          - ê°„ê²©/íƒ€ì´í¬/ìƒ‰ìƒ ì‚¬ìš©ì´ ì¼ê´€ë˜ì–´ì•¼ í•œë‹¤.
          - ì• ë‹ˆë©”ì´ì…˜/ì „í™˜ì´ ê¸°ì¡´ íŒ¨í„´ê³¼ ì¶©ëŒí•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

          ### 4. ì •í™•ì„± (0-20)
          - ë¡œì§ì´ ìš”êµ¬ì‚¬í•­ê³¼ ì—£ì§€ ì¼€ì´ìŠ¤ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.
          - ëª…ë°±í•œ ë²„ê·¸/ëŸ°íƒ€ì„ ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì´ ì—†ì–´ì•¼ í•œë‹¤.
          - ìƒíƒœ ê´€ë¦¬(ê²½í•©, stale closure ë“±)ê°€ ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•´ì•¼ í•œë‹¤.
          - API ì—°ë™(ë¡œë”©/ì˜¤ë¥˜/ì˜ˆì™¸ íë¦„)ì´ ì •í™•í•´ì•¼ í•œë‹¤.
          - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ/íƒ€ì´ë¨¸ ë“± ë¦¬ì†ŒìŠ¤ ì •ë¦¬ê°€ ëˆ„ë½ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

          ### 5. ì„±ëŠ¥ (0-20)
          - ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ê°€ ìµœì†Œí™”ë˜ì–´ì•¼ í•œë‹¤.
          - ë¼ìš°íŠ¸/ëŒ€í˜• ì»´í¬ë„ŒíŠ¸ ì§€ì—° ë¡œë”©ì´ ì ì ˆíˆ ì ìš©ë˜ì–´ì•¼ í•œë‹¤.
          - ë²ˆë“¤ í¬ê¸°/ì˜ì¡´ì„± ì‚¬ìš©ì´ í•©ë¦¬ì ì´ì–´ì•¼ í•œë‹¤.
          - ë¦¬ìŠ¤íŠ¸ ë Œë”ë§(key, ê°€ìƒí™” ë“±)ì´ íš¨ìœ¨ì ì´ì–´ì•¼ í•œë‹¤.
          - ì´ë¯¸ì§€/ë¯¸ë””ì–´ ë¡œë”© ì „ëµì´ ìµœì í™”ë˜ì–´ì•¼ í•œë‹¤.

          ---

          ## ì¶œë ¥ í˜•ì‹ (í•„ìˆ˜)

          ì•„ë˜ í˜•ì‹ì„ ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ë”°ë¥¸ë‹¤.
          ê³„ì¸µì€ Markdown í—¤ë”ë¥¼ ì‚¬ìš©í•œë‹¤: H2(`##`) > H3(`###`).

          ```markdown
          ## ìš”ì•½
          - ì´ì : {5ê°œ ì ìˆ˜ í•©ê³„}/100
          - íŒì •: {í•©ê²© (ğŸŸ¢ O) if ì´ì  >= 80, ë¶ˆí•©ê²© (ğŸ”´ X) if ì´ì  < 80}
          - ì´í‰: {ì „ì²´ í‰ê°€ 1~2ë¬¸ì¥}

          ## 1. ë³´ì•ˆ
          ### ì ìˆ˜
          ì ìˆ˜: {number}/20
          ### ë¬¸ì œ
          - {ë¬¸ì œ ì„¤ëª…}
          ### í•´ê²° ë°©ë²•
          - {í•´ê²° ë°©ì•ˆ}
          ### ì˜ˆì‹œ
          ```tsx
          {ì½”ë“œ ì˜ˆì‹œ ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ"}
          ```

          ## 2. ì½”ë“œ í’ˆì§ˆ
          ### ì ìˆ˜
          ì ìˆ˜: {number}/20
          ### ë¬¸ì œ
          - {ë¬¸ì œ ì„¤ëª…}
          ### í•´ê²° ë°©ë²•
          - {í•´ê²° ë°©ì•ˆ}
          ### ì˜ˆì‹œ
          ```tsx
          {ì½”ë“œ ì˜ˆì‹œ ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ"}
          ```

          ## 3. UI/UX ë° ì ‘ê·¼ì„±
          ### ì ìˆ˜
          ì ìˆ˜: {number}/20
          ### ë¬¸ì œ
          - {ë¬¸ì œ ì„¤ëª…}
          ### í•´ê²° ë°©ë²•
          - {í•´ê²° ë°©ì•ˆ}
          ### ì˜ˆì‹œ
          ```tsx
          {ì½”ë“œ ì˜ˆì‹œ ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ"}
          ```

          ## 4. ì •í™•ì„±
          ### ì ìˆ˜
          ì ìˆ˜: {number}/20
          ### ë¬¸ì œ
          - {ë¬¸ì œ ì„¤ëª…}
          ### í•´ê²° ë°©ë²•
          - {í•´ê²° ë°©ì•ˆ}
          ### ì˜ˆì‹œ
          ```tsx
          {ì½”ë“œ ì˜ˆì‹œ ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ"}
          ```

          ## 5. ì„±ëŠ¥
          ### ì ìˆ˜
          ì ìˆ˜: {number}/20
          ### ë¬¸ì œ
          - {ë¬¸ì œ ì„¤ëª…}
          ### í•´ê²° ë°©ë²•
          - {í•´ê²° ë°©ì•ˆ}
          ### ì˜ˆì‹œ
          ```tsx
          {ì½”ë“œ ì˜ˆì‹œ ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ"}
          ```
          ```

          ### ê·œì¹™
          1. ê° ì ìˆ˜ëŠ” 0~20ì˜ ì •ìˆ˜ë§Œ ì‚¬ìš©í•œë‹¤.
          2. ì´ì ì€ 5ê°œ ì ìˆ˜ì˜ ì •í™•í•œ í•©ì´ì–´ì•¼ í•œë‹¤.
          3. íŒì •ì€ ë°˜ë“œì‹œ `í•©ê²© (ğŸŸ¢ O)` ë˜ëŠ” `ë¶ˆí•©ê²© (ğŸ”´ X)`ë§Œ ì‚¬ìš©í•œë‹¤.
          4. ê° ì¹´í…Œê³ ë¦¬ì˜ `### ë¬¸ì œ`ëŠ” bullet ê¸°ì¤€ 0~3ê°œê¹Œì§€ ì‘ì„±í•œë‹¤.
          5. ë¬¸ì œê°€ ì—†ìœ¼ë©´ `- ì—†ìŒ` í•œ ì¤„ë§Œ ì‘ì„±í•œë‹¤.
          6. ê° ì¹´í…Œê³ ë¦¬ëŠ” `### ì ìˆ˜`, `### ë¬¸ì œ`, `### í•´ê²° ë°©ë²•`, `### ì˜ˆì‹œ`ë¥¼ ëª¨ë‘ í¬í•¨í•œë‹¤.
          7. 5ê°œ ì¹´í…Œê³ ë¦¬ H2 ì œëª©ì€ ë°˜ë“œì‹œ ë²ˆí˜¸ë¥¼ í¬í•¨í•œë‹¤ (`## 1. ë³´ì•ˆ` ~ `## 5. ì„±ëŠ¥`).
          8. ìš”ì•½ì˜ `ì´ì `, `íŒì •`, `ì´í‰`ì€ ë°˜ë“œì‹œ `- ` ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.
          9. ë¬¸ì œ/í•´ê²° ë°©ë²•ì€ ê°€ëŠ¥í•œ ê²½ìš° íŒŒì¼ ê²½ë¡œì™€ ë¼ì¸ ì •ë³´ë¥¼ í¬í•¨í•œë‹¤ (`path:line`).
          10. ì„¤ëª…ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤.
          EOF

          python - <<'PY'
          import json
          import os
          import urllib.request

          repo_full = os.environ.get("REPO_FULL", "")
          owner, repo = repo_full.split("/", 1)
          pr_number = int(os.environ["PR_NUMBER"])
          token = os.environ.get("GH_TOKEN", "")
          pr_body = (os.environ.get("PR_BODY") or "").strip()
          if not pr_body:
            pr_body = "None"
          elif len(pr_body) > 4000:
            pr_body = pr_body[:4000] + "\n...[truncated]"

          query = """
          query($owner: String!, $repo: String!, $number: Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $number) {
                closingIssuesReferences(first: 10) {
                  nodes {
                    number
                    title
                    url
                    state
                    bodyText
                  }
                }
              }
            }
          }
          """

          issue_nodes = []
          issue_lookup_error = ""
          try:
            req_body = json.dumps(
              {
                "query": query,
                "variables": {"owner": owner, "repo": repo, "number": pr_number},
              }
            ).encode("utf-8")
            req = urllib.request.Request(
              "https://api.github.com/graphql",
              data=req_body,
              headers={
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json",
                "Accept": "application/vnd.github+json",
              },
              method="POST",
            )
            with urllib.request.urlopen(req, timeout=20) as resp:
              payload = json.loads(resp.read().decode("utf-8", errors="replace"))
            issue_nodes = (
              payload.get("data", {})
              .get("repository", {})
              .get("pullRequest", {})
              .get("closingIssuesReferences", {})
              .get("nodes", [])
              or []
            )
          except Exception as exc:
            issue_lookup_error = str(exc)

          def one_line(text: str, limit: int) -> str:
            compact = " ".join((text or "").split())
            if not compact:
              return "N/A"
            if len(compact) > limit:
              return compact[:limit] + "..."
            return compact

          with open("pr_context.md", "w", encoding="utf-8") as out:
            out.write("PR body:\n")
            out.write(pr_body + "\n\n")
            out.write("Linked issues:\n")
            if issue_nodes:
              for node in issue_nodes:
                number = node.get("number")
                state = one_line(node.get("state", ""), 30)
                title = one_line(node.get("title", ""), 200)
                url = one_line(node.get("url", ""), 400)
                body = one_line(node.get("bodyText", ""), 240)
                out.write(f"- #{number} [{state}] {title} ({url})\n")
                out.write(f"  Context: {body}\n")
            else:
              if issue_lookup_error:
                out.write(f"- None (lookup failed: {one_line(issue_lookup_error, 160)})\n")
              else:
                out.write("- None\n")
          PY

          {
            echo ""
            echo "---"
            echo "PR number: ${PR_NUMBER}"
            echo "PR title: ${PR_TITLE}"
            echo "PR author: ${PR_AUTHOR}"
            echo "Diff truncated: ${DIFF_TRUNCATED}"
            echo ""
            echo "PR body and linked issues:"
          } >> codex_prompt.md
          cat pr_context.md >> codex_prompt.md
          {
            echo ""
            echo "DIFF:"
          } >> codex_prompt.md
          cat pr.diff >> codex_prompt.md

      - name: Run Codex with selected model
        id: codex_model
        uses: openai/codex-action@v1
        continue-on-error: true
        with:
          openai-api-key: ${{ secrets.CODEX_API_TOKEN }}
          prompt-file: codex_prompt.md
          model: ${{ inputs.model || 'gpt-5.2-codex' }}
          sandbox: read-only
          safety-strategy: drop-sudo
          allow-bots: true

      - name: Run Codex with auto-selected model
        id: codex_auto
        if: ${{ steps.codex_model.outcome != 'success' }}
        uses: openai/codex-action@v1
        continue-on-error: true
        with:
          openai-api-key: ${{ secrets.CODEX_API_TOKEN }}
          prompt-file: codex_prompt.md
          sandbox: read-only
          safety-strategy: drop-sudo
          allow-bots: true

      - name: Prepare review output
        id: call
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.codex_auto.outputs.final-message || steps.codex_model.outputs.final-message }}
          CODEX_OUTCOME: ${{ steps.codex_auto.outcome || steps.codex_model.outcome || 'failure' }}
          CODEX_MODEL_OUTCOME: ${{ steps.codex_model.outcome || 'skipped' }}
          CODEX_AUTO_OUTCOME: ${{ steps.codex_auto.outcome || 'skipped' }}
          REQUESTED_MODEL: ${{ inputs.model || 'gpt-5.2-codex' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, re

          raw = os.environ.get("CODEX_FINAL_MESSAGE") or ""
          outcome = os.environ.get("CODEX_OUTCOME") or ""
          model_outcome = os.environ.get("CODEX_MODEL_OUTCOME") or ""
          auto_outcome = os.environ.get("CODEX_AUTO_OUTCOME") or ""
          requested_model = os.environ.get("REQUESTED_MODEL") or ""
          run_url = os.environ.get("RUN_URL") or ""

          def fallback(reason: str) -> str:
            reason = reason.strip().replace("\n", " ")
            return "\n".join([
              "## ìš”ì•½",
              "- ì´ì : 0/100",
              "- íŒì •: ë¶ˆí•©ê²© (ğŸ”´ X)",
              "- ì´í‰: Codex ë¦¬ë·° ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.",
              "",
              "## 1. ë³´ì•ˆ",
              "### ì ìˆ˜",
              "ì ìˆ˜: 0/20",
              "### ë¬¸ì œ",
              f"- {reason}",
              "### í•´ê²° ë°©ë²•",
              "- í•´ë‹¹ ì—†ìŒ",
              "### ì˜ˆì‹œ",
              "```text",
              "í•´ë‹¹ ì—†ìŒ",
              "```",
              "",
              "## 2. ì½”ë“œ í’ˆì§ˆ",
              "### ì ìˆ˜",
              "ì ìˆ˜: 0/20",
              "### ë¬¸ì œ",
              "- ì—†ìŒ",
              "### í•´ê²° ë°©ë²•",
              "- í•´ë‹¹ ì—†ìŒ",
              "### ì˜ˆì‹œ",
              "```text",
              "í•´ë‹¹ ì—†ìŒ",
              "```",
              "",
              "## 3. UI/UX ë° ì ‘ê·¼ì„±",
              "### ì ìˆ˜",
              "ì ìˆ˜: 0/20",
              "### ë¬¸ì œ",
              "- ì—†ìŒ",
              "### í•´ê²° ë°©ë²•",
              "- í•´ë‹¹ ì—†ìŒ",
              "### ì˜ˆì‹œ",
              "```text",
              "í•´ë‹¹ ì—†ìŒ",
              "```",
              "",
              "## 4. ì •í™•ì„±",
              "### ì ìˆ˜",
              "ì ìˆ˜: 0/20",
              "### ë¬¸ì œ",
              "- ì—†ìŒ",
              "### í•´ê²° ë°©ë²•",
              "- í•´ë‹¹ ì—†ìŒ",
              "### ì˜ˆì‹œ",
              "```text",
              "í•´ë‹¹ ì—†ìŒ",
              "```",
              "",
              "## 5. ì„±ëŠ¥",
              "### ì ìˆ˜",
              "ì ìˆ˜: 0/20",
              "### ë¬¸ì œ",
              "- ì—†ìŒ",
              "### í•´ê²° ë°©ë²•",
              "- í•´ë‹¹ ì—†ìŒ",
              "### ì˜ˆì‹œ",
              "```text",
              "í•´ë‹¹ ì—†ìŒ",
              "```",
              "",
            ])

          def is_valid_template(s: str) -> tuple[bool, str]:
            required_h2 = ["ìš”ì•½", "1. ë³´ì•ˆ", "2. ì½”ë“œ í’ˆì§ˆ", "3. UI/UX ë° ì ‘ê·¼ì„±", "4. ì •í™•ì„±", "5. ì„±ëŠ¥"]
            for section in required_h2:
              if f"## {section}" not in s:
                return False, f"Missing H2 section: {section}"

            score_re = re.compile(r"^ì ìˆ˜:\s*(\d{1,2})/20\s*$", re.MULTILINE)
            scores = [int(x) for x in score_re.findall(s)]
            if len(scores) < 5:
              return False, f"Expected 5 ì ìˆ˜ lines, found {len(scores)}"
            scores = scores[:5]
            if any(x < 0 or x > 20 for x in scores):
              return False, "Score out of range"

            m_total = re.search(r"^- ì´ì :\s*(\d{1,3})/100\s*$", s, re.MULTILINE)
            if not m_total:
              return False, "Missing ì´ì  line"
            total = int(m_total.group(1))
            if total != sum(scores):
              return False, f"ì´ì  mismatch (got {total}, expected {sum(scores)})"

            m_verdict = re.search(r"^- íŒì •:\s*(í•©ê²©|ë¶ˆí•©ê²©)\s*\(([^)]+)\)\s*$", s, re.MULTILINE)
            if not m_verdict:
              return False, "Missing íŒì • line"
            verdict = m_verdict.group(1)
            marker = m_verdict.group(2).strip()
            expected = "í•©ê²©" if total >= 80 else "ë¶ˆí•©ê²©"
            if verdict != expected:
              return False, f"íŒì • mismatch (got {verdict}, expected {expected})"
            expected_marker = "ğŸŸ¢ O" if expected == "í•©ê²©" else "ğŸ”´ X"
            if marker != expected_marker:
              return False, f"íŒì • marker mismatch (got {marker}, expected {expected_marker})"

            if not re.search(r"^- ì´í‰:\s*.+$", s, re.MULTILINE):
              return False, "Missing ì´í‰ line"

            section_names = ["1. ë³´ì•ˆ", "2. ì½”ë“œ í’ˆì§ˆ", "3. UI/UX ë° ì ‘ê·¼ì„±", "4. ì •í™•ì„±", "5. ì„±ëŠ¥"]
            for section in section_names:
              m_section = re.search(
                rf"## {re.escape(section)}\n(?P<body>.*?)(?=\n## |\Z)",
                s,
                re.DOTALL,
              )
              if not m_section:
                return False, f"Missing section body: {section}"
              body = m_section.group("body")
              for required_h3 in ["### ì ìˆ˜", "### ë¬¸ì œ", "### í•´ê²° ë°©ë²•", "### ì˜ˆì‹œ"]:
                if required_h3 not in body:
                  return False, f"Missing {required_h3} in {section}"

              try:
                issues_part = body.split("### ë¬¸ì œ\n", 1)[1].split("\n### í•´ê²° ë°©ë²•", 1)[0]
              except Exception:
                return False, f"Cannot parse ë¬¸ì œ block in {section}"

              issue_lines = [ln.strip() for ln in issues_part.splitlines() if ln.strip().startswith("- ")]
              if not issue_lines:
                return False, f"ë¬¸ì œ bullet missing in {section}"
              if issue_lines == ["- ì—†ìŒ"]:
                pass
              else:
                if any(ln == "- ì—†ìŒ" for ln in issue_lines):
                  return False, f"ë¬¸ì œ block mixes 'ì—†ìŒ' with other issues in {section}"
                if len(issue_lines) > 3:
                  return False, f"ë¬¸ì œ bullet count exceeds 3 in {section}"

            return True, ""

          if not raw.strip():
            if requested_model:
              reason = f"Codex produced no output. requested_model={requested_model}, model_outcome={model_outcome}, auto_outcome={auto_outcome}, outcome={outcome}. Logs: {run_url}"
            else:
              reason = f"Codex produced no output. auto_outcome={auto_outcome}, outcome={outcome}. Logs: {run_url}"
            out = fallback(reason)
            ok = False
          else:
            valid, why = is_valid_template(raw)
            if not valid:
              out = fallback(f"Codex output invalid: {why}. Logs: {run_url}")
              ok = False
            else:
              out = raw.strip() + "\n"
              ok = True

          open("comment.md", "w", encoding="utf-8").write(out)
          open(os.environ.get("GITHUB_OUTPUT"), "a", encoding="utf-8").write(f"api_ok={'true' if ok else 'false'}\n")
          PY

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          owner="${{ github.repository_owner }}"
          repo="$(echo "${{ github.repository }}" | cut -d/ -f2)"
          pr="${{ github.event.pull_request.number }}"

          python - <<'PY' > body.json
          import json
          body = open("comment.md", "r", encoding="utf-8", errors="replace").read()
          print(json.dumps({"body": body}))
          PY

          curl -sS -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d @body.json \
            "https://api.github.com/repos/${owner}/${repo}/issues/${pr}/comments" \
            > /dev/null

      - name: Fail job if Codex failed
        if: ${{ steps.call.outputs.api_ok != 'true' }}
        run: |
          set -euo pipefail
          echo "Codex review failed. See the PR comment and job logs for details." >&2
          exit 1
